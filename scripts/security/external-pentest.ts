#!/usr/bin/env ts-node
/**
 * External Penetration Test Preparation Script
 * 
 * This script prepares the environment for external penetration testing:
 * - Generates testing credentials with limited scope
 * * Documents all test URLs and endpoints
 * - Prepares environment variables for pen testers
 * - Generates security assessment checklist
 * 
 * Usage: npx ts-node scripts/security/external-pentest.ts [--generate-creds] [--checklist] [--help]
 */

import * as fs from 'fs';
import * as path from 'path';
import { v4 as uuidv4 } from 'uuid';

/**
 * Penetration test configuration
 */
interface PentestConfig {
  /** Test environment URL */
  environmentUrl: string;
  /** API base URL */
  apiBaseUrl: string;
  /** Test duration in days */
  testDuration: number;
  /** IP whitelist for testing */
  ipWhitelist: string[];
  /** Allowed endpoints for testing */
  allowedEndpoints: string[];
  /** Restricted endpoints (must not test) */
  restrictedEndpoints: string[];
}

/**
 * Testing credentials for external pen testers
 */
interface TestingCredentials {
  /** API key for testing */
  apiKey: string;
  /** Test organization ID */
  orgId: string;
  /** Test user ID */
  userId: string;
  /** Permissions scope */
  permissions: string[];
  /** Expiration date */
  expiresAt: string;
  /** IP restrictions */
  allowedIps: string[];
}

/**
 * Security assessment checklist item
 */
interface ChecklistItem {
  /** Category of the check */
  category: string;
  /** Specific check description */
  check: string;
  /** Expected result */
  expectedResult: string;
  /** Tool/command to use */
  tool: string;
  /** Priority level */
  priority: 'critical' | 'high' | 'medium' | 'low';
  /** Status */
  status: 'pending' | 'passed' | 'failed' | 'na';
}

/**
 * Default penetration test configuration
 */
const DEFAULT_CONFIG: PentestConfig = {
  environmentUrl: process.env.PENTEST_ENV_URL || 'https://staging.healthcare-ai.example.com',
  apiBaseUrl: process.env.PENTEST_API_URL || 'https://staging-api.healthcare-ai.example.com',
  testDuration: 7,
  ipWhitelist: [],
  allowedEndpoints: [
    '/api/auth/login',
    '/api/auth/register',
    '/api/chat',
    '/api/documents',
    '/api/search',
    '/api/feedback',
  ],
  restrictedEndpoints: [
    '/api/admin/*',
    '/api/internal/*',
    '/api/system/*',
    '/api/user/*/password',
    '/api/user/*/mfa',
  ],
};

/**
 * Generate penetration test credentials
 */
function generateTestingCredentials(config: PentestConfig): TestingCredentials {
  const expirationDate = new Date();
  expirationDate.setDate(expirationDate.getDate() + config.testDuration);

  return {
    apiKey: `pk_test_${uuidv4().replace(/-/g, '')}`,
    orgId: `org_pentest_${uuidv4().substring(0, 8)}`,
    userId: `user_pentester_${uuidv4().substring(0, 8)}`,
    permissions: [
      'CHAT_ACCESS',
      'DOC_VIEW',
      'DOC_UPLOAD',
      'FEEDBACK_SUBMIT',
      'HISTORY_VIEW',
    ],
    expiresAt: expirationDate.toISOString(),
    allowedIps: config.ipWhitelist,
  };
}

/**
 * Generate environment variables file for pen testers
 */
function generateEnvFile(credentials: TestingCredentials, config: PentestConfig): string {
  return `# Healthcare AI Assistant - Penetration Test Environment Variables
# Generated: ${new Date().toISOString()}
# EXPIRES: ${credentials.expiresAt}

# Application URLs
PENTEST_ENV_URL=${config.environmentUrl}
PENTEST_API_URL=${config.apiBaseUrl}

# Test Credentials (RESTRICTED SCOPE)
PENTEST_API_KEY=${credentials.apiKey}
PENTEST_ORG_ID=${credentials.orgId}
PENTEST_USER_ID=${credentials.userId}

# Permissions
PENTEST_PERMISSIONS=${credentials.permissions.join(',')}

# IP Restrictions
PENTEST_ALLOWED_IPS=${credentials.allowedIps.join(',')}

# Test Configuration
PENTEST_DURATION_DAYS=${config.testDuration}
PENTEST_EXPIRES_AT=${credentials.expiresAt}

# Notes:
# - These credentials have RESTRICTED permissions (no admin access)
# - Access is limited to specified IP addresses
# - Credentials automatically expire after ${config.testDuration} days
# - DO NOT use for production testing
# - Report all findings to: security@healthcare-ai.example.com
`;
}

/**
 * Generate comprehensive endpoints documentation
 */
function generateEndpointsDocumentation(config: PentestConfig): string {
  const endpoints = [
    {
      method: 'POST',
      path: '/api/auth/login',
      description: 'User authentication endpoint',
      parameters: 'email, password',
      expectedResponse: 'JWT access token',
      notes: 'Rate limited to 5 attempts/minute',
    },
    {
      method: 'POST',
      path: '/api/auth/register',
      description: 'New user registration',
      parameters: 'email, password, name, organization',
      expectedResponse: 'User created, verification email sent',
      notes: 'Requires email verification before login',
    },
    {
      method: 'POST',
      path: '/api/chat',
      description: 'Main chat endpoint for AI assistant',
      parameters: 'message, context (optional)',
      expectedResponse: 'AI response with citations',
      notes: 'Includes PHI detection and injection blocking',
    },
    {
      method: 'GET',
      path: '/api/documents',
      description: 'List documents for organization',
      parameters: 'page, limit, status (optional)',
      expectedResponse: 'Paginated document list',
      notes: 'Filtered by organization ID',
    },
    {
      method: 'POST',
      path: '/api/documents/upload',
      description: 'Upload new document',
      parameters: 'file, title, category',
      expectedResponse: 'Document created with processing status',
      notes: 'Scanned for PHI before storage',
    },
    {
      method: 'GET',
      path: '/api/documents/:id',
      description: 'Get specific document',
      parameters: 'document ID',
      expectedResponse: 'Document details and content',
      notes: 'Requires DOC_VIEW permission',
    },
    {
      method: 'GET',
      path: '/api/search',
      description: 'Search documents using RAG',
      parameters: 'query, filters (optional)',
      expectedResponse: 'Relevant document chunks with citations',
      notes: 'Includes groundedness scoring',
    },
    {
      method: 'POST',
      path: '/api/feedback',
      description: 'Submit feedback on AI response',
      parameters: 'messageId, helpful (boolean), comment (optional)',
      expectedResponse: 'Feedback recorded',
      notes: 'Logged for quality improvement',
    },
    {
      method: 'GET',
      path: '/api/audit/logs',
      description: 'Get audit logs (admin only)',
      parameters: 'filters, pagination',
      expectedResponse: 'Paginated audit events',
      notes: 'Requires AUDIT_VIEW permission',
    },
    {
      method: 'GET',
      path: '/api/health',
      description: 'Health check endpoint',
      parameters: 'none',
      expectedResponse: 'System health status',
      notes: 'Public endpoint for monitoring',
    },
  ];

  let documentation = `# Penetration Test - Endpoints Documentation
Generated: ${new Date().toISOString()}
Environment: ${config.environmentUrl}

## Overview
This document describes the available endpoints for penetration testing.
All endpoints should be tested for security vulnerabilities.

## Authentication
Most endpoints require authentication via JWT bearer token.
Include header: \`Authorization: Bearer <access_token>\`

## Rate Limiting
- Auth endpoints: 5 requests/minute
- Chat API: 60 requests/minute per user
- General API: 100 requests/minute per organization

## Endpoints

`;

  endpoints.forEach((endpoint) => {
    documentation += `### ${endpoint.method} ${endpoint.path}
**Description:** ${endpoint.description}

**Parameters:** ${endpoint.parameters}

**Expected Response:** ${endpoint.expectedResponse}

**Notes:** ${endpoint.notes}

---
`;
  });

  documentation += `
## Restricted Endpoints (DO NOT TEST)
These endpoints are off-limits for penetration testing:
${config.restrictedEndpoints.map((ep) => `- ${ep}`).join('\n')}

## Test Environment Notes
- Use staging environment: ${config.environmentUrl}
- Test data is isolated and can be reset
- Coordinate testing windows with security team
- Report critical findings immediately
`;

  return documentation;
}

/**
 * Generate security assessment checklist
 */
function generateChecklist(): ChecklistItem[] {
  return [
    // Authentication & Access Control
    {
      category: 'Authentication',
      check: 'Brute force protection on login endpoint',
      expectedResult: 'Account locked after 5 failed attempts',
      tool: 'Burp Suite Intruder',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Authentication',
      check: 'Password policy enforcement',
      expectedResult: 'Minimum 12 chars, complexity requirements',
      tool: 'Manual + Nmap',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Authentication',
      check: 'Session management security',
      expectedResult: 'Secure session cookies, proper timeout',
      tool: 'Browser DevTools',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Access Control',
      check: 'IDOR vulnerabilities (Insecure Direct Object References)',
      expectedResult: 'Cannot access other users/organizations data',
      tool: 'Burp Suite + Manual',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Access Control',
      check: 'Privilege escalation prevention',
      expectedResult: 'Cannot elevate privileges beyond assigned role',
      tool: 'Burp Suite',
      priority: 'critical',
      status: 'pending',
    },

    // Input Validation
    {
      category: 'Input Validation',
      check: 'SQL injection prevention',
      expectedResult: 'All input sanitized, parameterized queries',
      tool: 'SQLMap + Manual',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Input Validation',
      check: 'XSS prevention (Reflected, Stored, DOM)',
      expectedResult: 'No script execution from user input',
      tool: 'Burp Suite + XSSer',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Input Validation',
      check: 'Command injection prevention',
      expectedResult: 'No OS command execution from input',
      tool: 'Manual + Burp Suite',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Input Validation',
      check: 'File upload security',
      expectedResult: 'Restricted file types, malware scanning',
      tool: 'Manual + File upload tools',
      priority: 'high',
      status: 'pending',
    },

    // AI-Specific Security
    {
      category: 'AI Security',
      check: 'Prompt injection attacks',
      expectedResult: 'System prompts not leaked or overridden',
      tool: 'Manual + Custom payloads',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'AI Security',
      check: 'Jailbreak attempts',
      expectedResult: 'No successful jailbreak, attacks blocked',
      tool: ' jailbreak libraries + Manual',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'AI Security',
      check: 'PHI information leakage in responses',
      expectedResult: 'No PHI exposed in AI responses',
      tool: 'Manual + Custom payloads with PHI',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'AI Security',
      check: 'Vector database injection',
      expectedResult: 'Malicious payloads not stored in vectors',
      tool: 'Manual + Vector DB tools',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'AI Security',
      check: 'Citation manipulation',
      expectedResult: 'Citations verified and not spoofable',
      tool: 'Manual testing',
      priority: 'medium',
      status: 'pending',
    },

    // Data Protection
    {
      category: 'Data Protection',
      check: 'Encryption at rest for PHI',
      expectedResult: 'PHI encrypted in database',
      tool: 'Database inspection',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Data Protection',
      check: 'Encryption in transit (TLS)',
      expectedResult: 'All traffic encrypted, TLS 1.2+',
      tool: 'SSL Labs + Nmap',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Data Protection',
      check: 'Sensitive data exposure in API responses',
      expectedResult: 'No PHI, passwords, or secrets in responses',
      tool: 'Burp Suite',
      priority: 'critical',
      status: 'pending',
    },
    {
      category: 'Data Protection',
      check: 'Cross-tenant data isolation',
      expectedResult: 'Cannot access other organization data',
      tool: 'Burp Suite + Manual',
      priority: 'critical',
      status: 'pending',
    },

    // Infrastructure
    {
      category: 'Infrastructure',
      check: 'Security headers configuration',
      expectedResult: 'HSTS, CSP, X-Frame-Options, etc.',
      tool: 'Security Headers Scanner',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Infrastructure',
      check: 'CORS configuration',
      expectedResult: 'Proper origin validation, no wildcards',
      tool: 'Manual + CORS scanners',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Infrastructure',
      check: 'Rate limiting effectiveness',
      expectedResult: 'Requests throttled appropriately',
      tool: 'Custom scripts',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Infrastructure',
      check: 'SSRF prevention',
      expectedResult: 'No outbound requests to internal resources',
      tool: 'SSRF testing tools',
      priority: 'critical',
      status: 'pending',
    },

    // Compliance
    {
      category: 'Compliance',
      check: 'Audit logging completeness',
      expectedResult: 'All security events logged',
      tool: 'Log analysis',
      priority: 'high',
      status: 'pending',
    },
    {
      category: 'Compliance',
      check: 'Data retention compliance',
      expectedResult: 'Data deleted after retention period',
      tool: 'Database inspection',
      priority: 'medium',
      status: 'pending',
    },
  ];
}

/**
 * Generate pen test preparation summary
 */
function generatePreparationSummary(
  credentials: TestingCredentials,
  config: PentestConfig
): string {
  return `# Penetration Test Preparation Summary
Generated: ${new Date().toISOString()}

## Environment
- URL: ${config.environmentUrl}
- API Base: ${config.apiBaseUrl}
- Duration: ${config.testDuration} days

## Credentials
- API Key: \`${credentials.apiKey}\`
- Organization ID: \`${credentials.orgId}\`
- User ID: \`${credentials.userId}\`
- Expires: ${credentials.expiresAt}

## Permissions Scope
${credentials.permissions.map((p) => `- ${p}`).join('\n')}

## IP Restrictions
${credentials.allowedIps.length > 0 
  ? credentials.allowedIps.map((ip) => `- ${ip}`).join('\n') 
  : '- No IP restrictions (update before production test)'}

## Documents Generated
1. \`pen-test-env.env\` - Environment variables for testing
2. \`pen-test-endpoints.md\` - Endpoint documentation
3. \`pen-test-checklist.md\` - Security assessment checklist

## Coordination
- Security Team Contact: security@healthcare-ai.example.com
- Test Window: Coordinate 48 hours in advance
- Findings Report: Immediate for critical issues

## Important Notes
‚ö†Ô∏è  Use ONLY in staging/penetration test environment
‚ö†Ô∏è  Credentials automatically expire
‚ö†Ô∏è  Do NOT test production systems
‚ö†Ô∏è  Report all findings immediately
`;
}

/**
 * Main execution function
 */
async function main(): Promise<void> {
  const args = process.argv.slice(2);
  const command = args[0] || '--help';

  switch (command) {
    case '--generate-creds':
      await generateCredentials();
      break;
    case '--checklist':
      await generateChecklistOnly();
      break;
    case '--prepare':
      await prepareAll();
      break;
    case '--help':
    default:
      showHelp();
      break;
  }
}

/**
 * Generate penetration test credentials
 */
async function generateCredentials(): Promise<void> {
  console.log('üîê Generating penetration test credentials...\n');

  const config = DEFAULT_CONFIG;
  const credentials = generateTestingCredentials(config);

  // Generate env file
  const envContent = generateEnvFile(credentials, config);
  fs.writeFileSync('pen-test-env.env', envContent);
  console.log('‚úÖ Created: pen-test-env.env');

  console.log('\nüìã Credentials Generated:');
  console.log(`   API Key: ${credentials.apiKey}`);
  console.log(`   Org ID: ${credentials.orgId}`);
  console.log(`   User ID: ${credentials.userId}`);
  console.log(`   Expires: ${credentials.expiresAt}`);
  console.log(`\n‚ö†Ô∏è  Store securely and share only with authorized pen testers`);
}

/**
 * Generate checklist only
 */
async function generateChecklistOnly(): Promise<void> {
  console.log('üìã Generating security assessment checklist...\n');

  const checklist = generateChecklist();
  const critical = checklist.filter((c) => c.priority === 'critical').length;
  const high = checklist.filter((c) => c.priority === 'high').length;

  console.log(`Total Checks: ${checklist.length}`);
  console.log(`Critical: ${critical}`);
  console.log(`High: ${high}`);
  console.log(`Medium: ${checklist.filter((c) => c.priority === 'medium').length}`);
  console.log(`Low: ${checklist.filter((c) => c.priority === 'low').length}`);

  // Generate markdown checklist
  let markdown = `# Penetration Test Security Assessment Checklist
Generated: ${new Date().toISOString()}

## Summary
- Total Checks: ${checklist.length}
- Critical: ${critical}
- High: ${high}
- Medium: ${checklist.filter((c) => c.priority === 'medium').length}
- Low: ${checklist.filter((c) => c.priority === 'low').length}

## Checklist

`;

  const categories = [...new Set(checklist.map((c) => c.category))];
  
  categories.forEach((category) => {
    markdown += `### ${category}\n\n`;
    markdown += `| Check | Expected Result | Tool | Priority | Status |\n`;
    markdown += `|-------|-----------------|------|----------|--------|\n`;
    
    checklist
      .filter((c) => c.category === category)
      .forEach((check) => {
        markdown += `| ${check.check} | ${check.expectedResult} | ${check.tool} | ${check.priority.toUpperCase()} | ${check.status} |\n`;
      });
    
    markdown += '\n';
  });

  fs.writeFileSync('pen-test-checklist.md', markdown);
  console.log('\n‚úÖ Created: pen-test-checklist.md');
}

/**
 * Prepare all penetration test materials
 */
async function prepareAll(): Promise<void> {
  console.log('üõ°Ô∏è  Preparing penetration test materials...\n');

  const config = DEFAULT_CONFIG;
  const credentials = generateTestingCredentials(config);

  // Generate all documents
  const envContent = generateEnvFile(credentials, config);
  fs.writeFileSync('pen-test-env.env', envContent);
  console.log('‚úÖ Created: pen-test-env.env');

  const endpointsContent = generateEndpointsDocumentation(config);
  fs.writeFileSync('pen-test-endpoints.md', endpointsContent);
  console.log('‚úÖ Created: pen-test-endpoints.md');

  const checklist = generateChecklist();
  let checklistMarkdown = `# Penetration Test Security Assessment Checklist
Generated: ${new Date().toISOString()}

## Summary
- Total Checks: ${checklist.length}
- Critical: ${checklist.filter((c) => c.priority === 'critical').length}
- High: ${checklist.filter((c) => c.priority === 'high').length}
- Medium: ${checklist.filter((c) => c.priority === 'medium').length}
- Low: ${checklist.filter((c) => c.priority === 'low').length}

## Checklist

`;

  const categories = [...new Set(checklist.map((c) => c.category))];
  
  categories.forEach((category) => {
    checklistMarkdown += `### ${category}\n\n`;
    checklistMarkdown += `| Check | Expected Result | Tool | Priority | Status |\n`;
    checklistMarkdown += `|-------|-----------------|------|----------|--------|\n`;
    
    checklist
      .filter((c) => c.category === category)
      .forEach((check) => {
        checklistMarkdown += `| ${check.check} | ${check.expectedResult} | ${check.tool} | ${check.priority.toUpperCase()} | ${check.status} |\n`;
      });
    
    checklistMarkdown += '\n';
  });

  fs.writeFileSync('pen-test-checklist.md', checklistMarkdown);
  console.log('‚úÖ Created: pen-test-checklist.md');

  const summary = generatePreparationSummary(credentials, config);
  fs.writeFileSync('pen-test-summary.md', summary);
  console.log('‚úÖ Created: pen-test-summary.md');

  console.log('\nüìÅ All penetration test materials prepared:');
  console.log('   - pen-test-env.env (environment variables)');
  console.log('   - pen-test-endpoints.md (API documentation)');
  console.log('   - pen-test-checklist.md (assessment checklist)');
  console.log('   - pen-test-summary.md (preparation summary)');
  console.log('\n‚ö†Ô∏è  Review all documents before sharing with pen testers');
}

/**
 * Show help message
 */
function showHelp(): void {
  console.log(`
üõ°Ô∏è  Healthcare AI Assistant - Penetration Test Preparation Tool

Usage: npx ts-node scripts/security/external-pentest.ts [command]

Commands:
  --generate-creds   Generate penetration test credentials only
  --checklist        Generate security assessment checklist only
  --prepare          Generate all penetration test materials
  --help             Show this help message

Examples:
  npx ts-node scripts/security/external-pentest.ts --prepare
  npx ts-node scripts/security/external-pentest.ts --generate-creds
  npx ts-node scripts/security/external-pentest.ts --checklist

Output Files:
  - pen-test-env.env        Environment variables for pen testers
  - pen-test-endpoints.md   API endpoint documentation
  - pen-test-checklist.md   Security assessment checklist
  - pen-test-summary.md     Preparation summary

‚ö†Ô∏è  Important:
  - Use ONLY in staging/penetration test environment
  - Credentials have restricted permissions and expire automatically
  - Coordinate testing windows with security team 48 hours in advance
  - Report critical findings immediately to security@healthcare-ai.example.com
`);
}

// Export for programmatic use
export {
  generateTestingCredentials,
  generateEnvFile,
  generateEndpointsDocumentation,
  generateChecklist,
  generatePreparationSummary,
  DEFAULT_CONFIG,
};

// Run if executed directly
if (require.main === module) {
  main().catch(console.error);
}
